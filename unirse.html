<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unirse a Sala - Preguntas con Sentido</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script>
        // ‚úÖ CONFIGURACI√ìN FIREBASE REAL
        const firebaseConfig = {
            apiKey: "AIzaSyAMLq68ijwQwmbfi1aq-yO0gK9TdCIstZ4",
            authDomain: "ccs-el-juego.firebaseapp.com",
            databaseURL: "https://ccs-el-juego-default-rtdb.firebaseio.com",
            projectId: "ccs-el-juego",
            storageBucket: "ccs-el-juego.firebasestorage.app",
            messagingSenderId: "1067594728486",
            appId: "1:1067594728486:web:a5510a9baba4d26e12d2e7"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        
        /* ‚úÖ FONDO FIJO MEJORADO - SIN SALTOS EN M√ìVIL */
        body {
            min-height: 100vh;
            color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow-x: hidden;
            background: none;
        }
        
        /* ‚úÖ NUEVO: Fondo usando pseudo-elemento */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80');
            background-size: cover;
            background-position: center;
            background-attachment: scroll;
            z-index: -1;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            will-change: transform;
        }

        .container {
            max-width: 500px;
            width: 100%;
            background: rgba(255, 255, 255, 0.15);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        /* HEADER */
        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .titulo-principal {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .subtitulo {
            font-size: 16px;
            opacity: 0.9;
            font-weight: 300;
        }

        /* FORMULARIO */
        .form-container {
            margin-bottom: 25px;
        }

        .input-grupo {
            margin-bottom: 20px;
        }

        .input-grupo label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .input-codigo {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 18px;
            text-align: center;
            letter-spacing: 3px;
            text-transform: uppercase;
            backdrop-filter: blur(10px);
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .input-codigo::placeholder {
            color: rgba(255, 255, 255, 0.5);
            letter-spacing: normal;
        }

        .input-codigo:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.6);
        }

        .input-nombre {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            backdrop-filter: blur(10px);
        }

        .input-nombre::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .input-nombre:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.6);
        }

        /* BOTONES */
        .btn-unirse {
            background: #27ae60;
            color: white;
            border: none;
            padding: 18px;
            font-size: 16px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-unirse:hover {
            background: #219653;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .btn-unirse:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
            transform: none;
            opacity: 0.6;
        }

        .btn-volver {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 15px;
            font-size: 14px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            width: 100%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
        }

        .btn-volver:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* INFO SALA */
        .info-sala {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: none;
        }

        .info-titulo {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-detalle {
            font-size: 14px;
            opacity: 0.9;
            line-height: 1.5;
        }

        .info-codigo {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 5px;
            margin: 0 3px;
        }

        /* LOADING */
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ERROR/SUCCESS */
        .mensaje {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            font-weight: 500;
        }

        .mensaje.error {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid rgba(231, 76, 60, 0.4);
            color: #ffcccc;
        }

        .mensaje.success {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid rgba(46, 204, 113, 0.4);
            color: #ccffcc;
        }

        /* PIE DE P√ÅGINA */
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .website-link {
            color: white;
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            opacity: 0.8;
            transition: all 0.3s ease;
        }

        .website-link:hover {
            opacity: 1;
            text-decoration: underline;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 0 15px;
            }
            
            .titulo-principal {
                font-size: 24px;
            }
            
            .input-codigo {
                font-size: 16px;
                padding: 12px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 15px;
            }
            
            .container {
                padding: 15px;
            }
            
            .titulo-principal {
                font-size: 22px;
            }
            
            .btn-unirse, .btn-volver {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1 class="titulo-principal">Unirse a Sala</h1>
            <p class="subtitulo">Ingresa el c√≥digo de la sala y tu nombre para jugar</p>
        </div>

        <!-- MENSAJES -->
        <div class="mensaje error" id="mensajeError"></div>
        <div class="mensaje success" id="mensajeSuccess"></div>

        <!-- LOADING -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Conectando con la sala...</p>
        </div>

        <!-- FORMULARIO PRINCIPAL -->
        <div class="form-container" id="formularioPrincipal">
            <div class="input-grupo">
                <label for="codigoSala">üìù C√ìDIGO DE SALA</label>
                <input type="text" 
                       id="codigoSala" 
                       class="input-codigo" 
                       placeholder="Ej: A1B2C3"
                       maxlength="6"
                       autocomplete="off"
                       autocapitalize="characters">
                <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">
                    Pega el c√≥digo de 6 letras que te compartieron
                </div>
            </div>

            <div class="input-grupo">
                <label for="nombreJugador">üë§ TU NOMBRE</label>
                <input type="text" 
                       id="nombreJugador" 
                       class="input-nombre" 
                       placeholder="¬øC√≥mo quieres que te llamen?"
                       maxlength="20">
            </div>

            <button class="btn-unirse" onclick="unirseASala()" id="btnUnirse">
                üéÆ Unirse a la Sala
            </button>

            <button class="btn-volver" onclick="volverAlInicio()">
                ‚Üê Volver al Inicio
            </button>
        </div>

        <!-- INFO DE SALA (se muestra despu√©s de unirse) -->
        <div class="info-sala" id="infoSala">
            <div class="info-titulo">
                <span>‚úÖ</span> Conectado a la sala
            </div>
            <div class="info-detalle">
                Sala: <span class="info-codigo" id="salaCodigoInfo">---</span> | 
                T√≥pico: <span id="salaTopicoInfo">---</span>
                <div style="margin-top: 10px; font-size: 14px;">
                    Redirigiendo a la sala en <span id="contador">5</span> segundos...
                </div>
            </div>
        </div>
    </div>

    <!-- PIE DE P√ÅGINA -->
    <div class="footer">
        <a href="https://www.7preguntas.com" class="website-link" target="_blank">
            www.7preguntas.com
        </a>
    </div>

    <script>
        let database = firebase.database();
        let codigoSala = '';
        let nombreJugador = '';
        let topicoSala = '';

        // NOMBRES DE T√ìPICOS
        const nombresTopicos = {
            'que': '¬øQu√©?',
            'espiritualidad': 'Espiritualidad',
            'familia': 'Familia', 
            'amigos': 'Amigos',
            'pareja': 'Pareja',
            'padre_hijos': 'Padre/Hijos',
            'colegio': 'Colegio',
            'desarrollo_personal': 'Desarrollo Personal'
        };

        // INICIALIZAR
        document.addEventListener('DOMContentLoaded', function() {
            // Obtener c√≥digo de la URL si existe
            const urlParams = new URLSearchParams(window.location.search);
            const codigoFromUrl = urlParams.get('codigo');
            
            if (codigoFromUrl) {
                document.getElementById('codigoSala').value = codigoFromUrl.toUpperCase();
            }

            // ENTER para unirse
            document.getElementById('codigoSala').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('nombreJugador').focus();
                }
            });

            document.getElementById('nombreJugador').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    unirseASala();
                }
            });

            // Auto-may√∫sculas para c√≥digo
            document.getElementById('codigoSala').addEventListener('input', function(e) {
                this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            });

            // Verificar si hay datos de sala anterior
            const salaAnterior = localStorage.getItem('salaActual');
            if (salaAnterior) {
                try {
                    const datos = JSON.parse(salaAnterior);
                    if (datos.codigo && datos.miNombre) {
                        document.getElementById('codigoSala').value = datos.codigo;
                        document.getElementById('nombreJugador').value = datos.miNombre;
                    }
                } catch (e) {
                    console.log('No hay datos de sala anteriores');
                }
            }
        });

        // UNIRSE A SALA
        function unirseASala() {
            codigoSala = document.getElementById('codigoSala').value.trim().toUpperCase();
            nombreJugador = document.getElementById('nombreJugador').value.trim();

            // Validaciones
            if (!codigoSala) {
                mostrarError('Por favor ingresa el c√≥digo de la sala');
                document.getElementById('codigoSala').focus();
                return;
            }

            if (codigoSala.length !== 6) {
                mostrarError('El c√≥digo debe tener exactamente 6 caracteres (ej: A1B2C3)');
                document.getElementById('codigoSala').focus();
                return;
            }

            if (!nombreJugador) {
                mostrarError('Por favor ingresa tu nombre');
                document.getElementById('nombreJugador').focus();
                return;
            }

            if (nombreJugador.length < 2) {
                mostrarError('Tu nombre debe tener al menos 2 caracteres');
                document.getElementById('nombreJugador').focus();
                return;
            }

            // Mostrar loading
            mostrarLoading(true);

            // Verificar si la sala existe
            database.ref('salas/' + codigoSala).once('value')
                .then(snapshot => {
                    const sala = snapshot.val();
                    
                    if (!sala) {
                        mostrarError('No se encontr√≥ la sala. Verifica el c√≥digo.');
                        mostrarLoading(false);
                        return;
                    }

                    // Verificar si la sala est√° llena (m√°ximo 10 jugadores)
                    const jugadoresActuales = sala.jugadores ? Object.keys(sala.jugadores).length : 0;
                    if (jugadoresActuales >= 10) {
                        mostrarError('La sala est√° llena (m√°ximo 10 jugadores)');
                        mostrarLoading(false);
                        return;
                    }

                    // Obtener t√≥pico de la sala
                    topicoSala = sala.topico || 'que';

                    // Verificar si el nombre ya existe en la sala
                    const nombreExiste = sala.jugadores ? 
                        Object.values(sala.jugadores).some(j => j.nombre === nombreJugador) : false;
                    
                    if (nombreExiste) {
                        mostrarError('Ya hay un jugador con ese nombre en la sala. Usa otro nombre.');
                        mostrarLoading(false);
                        return;
                    }

                    // Crear objeto del jugador
                    const jugadorData = {
                        nombre: nombreJugador,
                        esCreador: false,
                        turno: false, // El nuevo jugador no tiene turno inicial
                        conectado: true,
                        fechaUnion: new Date().toISOString()
                    };

                    // Agregar jugador a la sala
                    const nuevoJugadorKey = database.ref().push().key;
                    const updates = {};
                    updates[`jugadores/${nuevoJugadorKey}`] = jugadorData;

                    // Si no hay pregunta actual, establecer una
                    if (!sala.preguntaActual) {
                        const preguntas = obtenerPreguntasParaTopico(topicoSala);
                        if (preguntas.length > 0) {
                            updates['preguntaActual'] = preguntas[0];
                        }
                    }

                    return database.ref('salas/' + codigoSala).update(updates);
                })
                .then(() => {
                    // Guardar datos localmente
                    localStorage.setItem('salaActual', JSON.stringify({
                        codigo: codigoSala,
                        miNombre: nombreJugador,
                        topico: topicoSala,
                        esCreador: false,
                        miJugadorId: null // Se establecer√° al entrar a la sala
                    }));

                    // Mostrar √©xito
                    mostrarExito('¬°Te has unido a la sala exitosamente!');

                    // Mostrar info de la sala
                    document.getElementById('salaCodigoInfo').textContent = codigoSala;
                    document.getElementById('salaTopicoInfo').textContent = nombresTopicos[topicoSala] || topicoSala;
                    
                    // Ocultar formulario, mostrar info
                    document.getElementById('formularioPrincipal').style.display = 'none';
                    document.getElementById('infoSala').style.display = 'block';
                    mostrarLoading(false);

                    // Redirigir despu√©s de 5 segundos
                    let segundos = 5;
                    const contadorElement = document.getElementById('contador');
                    const intervalo = setInterval(() => {
                        segundos--;
                        contadorElement.textContent = segundos;
                        
                        if (segundos <= 0) {
                            clearInterval(intervalo);
                            irASala();
                        }
                    }, 1000);

                })
                .catch(error => {
                    console.error('Error uni√©ndose a sala:', error);
                    mostrarError('Error al unirse a la sala. Intenta nuevamente.');
                    mostrarLoading(false);
                });
        }

        // OBTENER PREGUNTAS PARA T√ìPICO
        function obtenerPreguntasParaTopico(topico) {
            const bancoPreguntas = {
                'que': ["¬øQu√© te hace sentir realmente vivo?"],
                'espiritualidad': ["¬øQu√© te da paz interior?"],
                'familia': ["¬øCu√°l es tu recuerdo m√°s valioso con tu familia?"],
                'amigos': ["¬øQu√© hace a una amistad verdadera?"],
                'pareja': ["¬øQu√© valoras m√°s en una relaci√≥n de pareja?"],
                'padre_hijos': ["¬øQu√© te gusta m√°s de ser padre/hijo?"],
                'colegio': ["¬øQu√© maestro recuerdas con m√°s cari√±o y por qu√©?"],
                'desarrollo_personal': ["¬øQu√© meta personal te emociona actualmente?"]
            };
            
            return bancoPreguntas[topico] || bancoPreguntas.que;
        }

        // IR A LA SALA
        function irASala() {
            window.location.href = `sala.html?sala=${codigoSala}`;
        }

        // VOLVER AL INICIO
        function volverAlInicio() {
            window.location.href = 'index.html';
        }

        // MOSTRAR MENSAJES
        function mostrarError(mensaje) {
            const errorElement = document.getElementById('mensajeError');
            errorElement.textContent = mensaje;
            errorElement.style.display = 'block';
            
            // Ocultar despu√©s de 5 segundos
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }

        function mostrarExito(mensaje) {
            const successElement = document.getElementById('mensajeSuccess');
            successElement.textContent = mensaje;
            successElement.style.display = 'block';
            
            setTimeout(() => {
                successElement.style.display = 'none';
            }, 3000);
        }

        function mostrarLoading(mostrar) {
            document.getElementById('loading').style.display = mostrar ? 'block' : 'none';
            document.getElementById('btnUnirse').disabled = mostrar;
        }

        // TECLAS R√ÅPIDAS
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                volverAlInicio();
            }
        });
    </script>
</body>
</html>