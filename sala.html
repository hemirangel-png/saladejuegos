<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversaciones con Sentido</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        
        body {
            background-image: url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80');
            background-size: cover;
            background-position: center;
            min-height: 100vh;
            color: white;
            padding: 15px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* HEADER MINI */
        .header {
            background: rgba(255, 255, 255, 0.15);
            padding: 12px;
            border-radius: 10px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-align: center;
        }

        .codigo-sala {
            background: rgba(39, 174, 96, 0.9);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 1px;
            margin-top: 5px;
            display: inline-block;
        }

        .info-topico {
            font-size: 14px;
            opacity: 0.8;
            margin-top: 5px;
        }

        /* TARJETA DE PREGUNTA PRINCIPAL */
        .pregunta-container {
            background: rgba(255, 255, 255, 0.15);
            padding: 25px;
            border-radius: 12px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-align: center;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .topico-titulo {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 8px;
        }

        .pregunta-texto {
            font-size: 22px;
            font-weight: 600;
            line-height: 1.3;
        }

        /* LISTA HORIZONTAL DE PARTICIPANTES */
        .participantes-container {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 15px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .participantes-lista {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            max-height: 120px;
            overflow-y: auto;
        }

        .participante {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 14px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .participante.activo {
            background: #27ae60;
            color: white;
            font-weight: 600;
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(39, 174, 96, 0.5);
        }

        .participante.facilitador {
            border: 2px solid #9b59b6;
        }

        /* TURNO ACTUAL */
        .turno-actual {
            background: rgba(155, 89, 182, 0.3);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .participante-actual {
            font-size: 18px;
            font-weight: 700;
            color: #9b59b6;
            margin-top: 5px;
        }

        /* CONTADOR DE TURNO */
        .contador-turno {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 5px;
        }

        /* BOT√ìN SIGUIENTE */
        .btn-siguiente {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .btn-siguiente:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-siguiente:disabled {
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.5);
            cursor: not-allowed;
            transform: none;
        }

        /* BOT√ìN VOLVER AL INICIO */
        .btn-volver-inicio {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.4);
            padding: 12px;
            font-size: 14px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            width: 100%;
            transition: all 0.3s ease;
        }

        .btn-volver-inicio:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* ANIMACI√ìN */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulsando {
            animation: pulse 2s infinite;
        }

        /* MENSAJE INFORMATIVO */
        .mensaje-info {
            background: rgba(52, 152, 219, 0.3);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-size: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 10px;
        }

        /* INDICADOR DE ESTADO */
        .estado-conexion {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 1000;
        }

        .estado-conexion.conectado {
            background: rgba(39, 174, 96, 0.8);
        }

        .estado-conexion.desconectado {
            background: rgba(231, 76, 60, 0.8);
        }

        /* MENSAJE DE ESPERA */
        .mensaje-espera {
            background: rgba(243, 156, 18, 0.3);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="estado-conexion" id="estadoConexion">üîÑ Sincronizando...</div>

    <div class="container">
        <!-- HEADER MINI -->
        <div class="header">
            <div style="font-size: 18px; font-weight: 600;">Conversaciones</div>
            <div class="codigo-sala" id="codigoSala">ABC123</div>
            <div class="info-topico" id="infoTopico">T√≥pico: Cargando...</div>
        </div>

        <!-- MENSAJE DE ESPERA -->
        <div class="mensaje-espera" id="mensajeEspera" style="display: none;">
            ‚è≥ Esperando al facilitador para iniciar la reuni√≥n...
        </div>

        <!-- TURNO ACTUAL -->
        <div class="turno-actual">
            <div>üé§ Turno de:</div>
            <div class="participante-actual" id="participanteActual">Cargando...</div>
            <div class="contador-turno" id="contadorTurno">Turno 1 de 1</div>
        </div>

        <!-- TARJETA DE PREGUNTA PRINCIPAL -->
        <div class="pregunta-container">
            <div class="topico-titulo" id="topicoTitulo">CARGANDO...</div>
            <div class="pregunta-texto" id="preguntaTexto">
                Cargando pregunta...
            </div>
        </div>

        <!-- LISTA HORIZONTAL DE PARTICIPANTES -->
        <div class="participantes-container">
            <div style="font-size: 14px; margin-bottom: 10px; text-align: center; color: rgba(255,255,255,0.8);">
                Participantes (<span id="contadorParticipantes">0</span>)
            </div>
            <div class="participantes-lista" id="listaParticipantes">
                <!-- Los participantes se cargan din√°micamente -->
            </div>
        </div>

        <!-- BOT√ìN SIGUIENTE -->
        <button class="btn-siguiente" id="btnSiguiente" onclick="siguienteTurno()">
            Siguiente Turno
        </button>

        <!-- BOT√ìN VOLVER AL INICIO -->
        <button class="btn-volver-inicio" onclick="volverAlInicio()">
            ‚Üê Volver al Inicio
        </button>
    </div>

    <script>
        // VARIABLES GLOBALES
        let participantes = [];
        let turnoActual = 0;
        let topicoActual = '';
        let codigoSala = '';
        let esFacilitador = false;
        let miNombre = '';
        let preguntaActual = '';
        let miId = '';
        let intervaloActualizacion = null;

        // SISTEMA DE SINCRONIZACI√ìN CON LOCALSTORAGE
        function inicializarSala() {
            const urlParams = new URLSearchParams(window.location.search);
            codigoSala = urlParams.get('codigo') || 'SINCODIGO';
            topicoActual = urlParams.get('topico') || 'general';
            miNombre = urlParams.get('participante') || 'An√≥nimo';
            esFacilitador = urlParams.get('creador') === 'true';
            miId = generarId();

            console.log('Inicializando sala:', { codigoSala, topicoActual, miNombre, esFacilitador });

            // Actualizar interfaz b√°sica
            document.getElementById('codigoSala').textContent = codigoSala;
            document.getElementById('infoTopico').textContent = `T√≥pico: ${obtenerNombreTopico(topicoActual)}`;
            document.getElementById('topicoTitulo').textContent = topicoActual.toUpperCase();

            // Verificar si la sala existe
            const salaData = localStorage.getItem(`sala_${codigoSala}`);
            console.log('Datos de sala encontrados:', salaData);
            
            if (!salaData) {
                alert('C√≥digo de sala no encontrado. Ser√°s redirigido al inicio.');
                setTimeout(volverAlInicio, 2000);
                return;
            }

            // Si soy facilitador, inicializar el estado de la sala
            if (esFacilitador) {
                inicializarEstadoSala();
            }

            // Agregarme a la lista de participantes
            agregarParticipante();

            // Cargar estado actual
            cargarEstadoSala();
            
            // Sincronizar cada 2 segundos
            intervaloActualizacion = setInterval(cargarEstadoSala, 2000);

            // Actualizar estado de conexi√≥n
            document.getElementById('estadoConexion').textContent = '‚úÖ Conectado';
            document.getElementById('estadoConexion').className = 'estado-conexion conectado';
        }

        // INICIALIZAR ESTADO DE LA SALA (solo facilitador)
        function inicializarEstadoSala() {
            const estadoExistente = localStorage.getItem(`sala_estado_${codigoSala}`);
            
            if (!estadoExistente) {
                const estadoInicial = {
                    participantes: [],
                    turnoActual: 0,
                    preguntaActual: generarPregunta(topicoActual),
                    timestamp: Date.now()
                };
                localStorage.setItem(`sala_estado_${codigoSala}`, JSON.stringify(estadoInicial));
                console.log('Estado de sala inicializado por facilitador');
            }
        }

        // AGREGAR PARTICIPANTE A LA SALA
        function agregarParticipante() {
            const estadoSala = localStorage.getItem(`sala_estado_${codigoSala}`);
            
            if (estadoSala) {
                const datos = JSON.parse(estadoSala);
                
                // Verificar si ya estoy en la lista
                const yaEstoyEnLista = datos.participantes.some(p => p.id === miId);
                
                if (!yaEstoyEnLista) {
                    // Agregarme a la lista
                    datos.participantes.push({ 
                        id: miId, 
                        nombre: miNombre, 
                        esFacilitador: esFacilitador 
                    });
                    
                    // Actualizar timestamp
                    datos.timestamp = Date.now();
                    
                    // Guardar cambios
                    localStorage.setItem(`sala_estado_${codigoSala}`, JSON.stringify(datos));
                    console.log('Participante agregado:', miNombre);
                }
            } else if (esFacilitador) {
                // Si soy facilitador y no hay estado, crear uno
                const estadoInicial = {
                    participantes: [{ 
                        id: miId, 
                        nombre: miNombre, 
                        esFacilitador: true 
                    }],
                    turnoActual: 0,
                    preguntaActual: generarPregunta(topicoActual),
                    timestamp: Date.now()
                };
                localStorage.setItem(`sala_estado_${codigoSala}`, JSON.stringify(estadoInicial));
                console.log('Estado creado por facilitador con participante');
            }
        }

        // CARGAR ESTADO DE LA SALA DESDE LOCALSTORAGE
        function cargarEstadoSala() {
            const estadoSala = localStorage.getItem(`sala_estado_${codigoSala}`);
            
            if (estadoSala) {
                const datos = JSON.parse(estadoSala);
                
                // Ocultar mensaje de espera
                document.getElementById('mensajeEspera').style.display = 'none';
                
                // Actualizar participantes
                participantes = datos.participantes;

                // Actualizar turno y pregunta
                turnoActual = datos.turnoActual;
                preguntaActual = datos.preguntaActual;

                // Actualizar interfaz
                actualizarInterfaz();
            } else {
                // Mostrar mensaje de espera si no hay estado (participante normal)
                if (!esFacilitador) {
                    document.getElementById('mensajeEspera').style.display = 'block';
                }
            }
        }

        // GUARDAR ESTADO DE LA SALA
        function guardarEstadoSala() {
            const estado = {
                participantes: participantes,
                turnoActual: turnoActual,
                preguntaActual: preguntaActual,
                timestamp: Date.now()
            };
            localStorage.setItem(`sala_estado_${codigoSala}`, JSON.stringify(estado));
        }

        // SIGUIENTE TURNO
        function siguienteTurno() {
            if (!esFacilitador) {
                alert('Solo el facilitador puede avanzar los turnos');
                return;
            }

            if (participantes.length === 0) return;

            // Avanzar turno
            turnoActual = (turnoActual + 1) % participantes.length;
            
            // Si es el primer turno, cambiar pregunta
            if (turnoActual === 0) {
                preguntaActual = generarPregunta(topicoActual);
            }

            guardarEstadoSala();
            actualizarInterfaz();
        }

        // ACTUALIZAR INTERFAZ
        function actualizarInterfaz() {
            // Actualizar lista de participantes
            const lista = document.getElementById('listaParticipantes');
            lista.innerHTML = '';
            
            participantes.forEach((participante, index) => {
                const span = document.createElement('span');
                span.className = 'participante';
                span.textContent = participante.nombre;
                span.id = `participante-${participante.id}`;
                
                if (index === turnoActual) {
                    span.classList.add('activo');
                    span.classList.add('pulsando');
                }
                
                if (participante.esFacilitador) {
                    span.classList.add('facilitador');
                }
                
                lista.appendChild(span);
            });

            // Actualizar turno actual
            const participanteEnTurno = participantes[turnoActual];
            if (participanteEnTurno) {
                document.getElementById('participanteActual').textContent = participanteEnTurno.nombre;
                document.getElementById('contadorTurno').textContent = `Turno ${turnoActual + 1} de ${participantes.length}`;
            }

            // Actualizar pregunta
            document.getElementById('preguntaTexto').textContent = preguntaActual;

            // Actualizar contador
            document.getElementById('contadorParticipantes').textContent = participantes.length;

            // Configurar bot√≥n siguiente
            const btnSiguiente = document.getElementById('btnSiguiente');
            btnSiguiente.disabled = !esFacilitador;
            if (!esFacilitador) {
                btnSiguiente.title = 'Solo el facilitador puede cambiar turnos';
            }
        }

        // GENERAR PREGUNTA ALEATORIA
        function generarPregunta(topico) {
            const preguntas = {
                'espiritualidad': [
                    "¬øQu√© te da paz interior?",
                    "¬øC√≥mo encuentras significado en la vida?",
                    "¬øQu√© creencias te gu√≠an?",
                    "¬øQu√© te conecta con algo mayor?",
                    "¬øQu√© pr√°ctica espiritual te nutre?"
                ],
                'familia': [
                    "¬øCu√°l es tu recuerdo m√°s valioso con tu familia?",
                    "¬øQu√© tradici√≥n familiar te gusta m√°s?",
                    "¬øQu√© aprendiste de tus padres?",
                    "¬øQu√© significa 'hogar' para ti?",
                    "¬øQu√© momento familiar te ha marcado m√°s?"
                ],
                'pareja': [
                    "¬øQu√© valoras m√°s en una relaci√≥n?",
                    "¬øC√≥mo construyes confianza?",
                    "¬øQu√© has aprendido del amor?",
                    "¬øQu√© hace especial una relaci√≥n?",
                    "¬øC√≥mo manejas los conflictos?"
                ],
                'padre_hijos': [
                    "¬øQu√© te gusta de ser padre/hijo?",
                    "¬øQu√© valor quieres transmitir?",
                    "¬øC√≥mo es tu relaci√≥n familiar?",
                    "¬øQu√© consejo dar√≠as sobre familia?",
                    "¬øQu√© momento con tus hijos/padres atesoras?"
                ],
                'colegio': [
                    "¬øQu√© maestro recuerdas con cari√±o?",
                    "¬øQu√© aprendiste en la escuela que usas hoy?",
                    "¬øQu√© experiencia escolar fue importante?",
                    "¬øQu√© recuerdo escolar te hace feliz?",
                    "¬øQu√© amistad escolar marc√≥ tu vida?"
                ],
                'desarrollo_personal': [
                    "¬øQu√© meta te emociona?",
                    "¬øQu√© h√°bito mejor√≥ tu vida?",
                    "¬øQu√© te gustar√≠a aprender?",
                    "¬øC√≥mo superas desaf√≠os?",
                    "¬øQu√© miedo has vencido?"
                ]
            };

            const preguntasTopico = preguntas[topico] || preguntas.familia;
            return preguntasTopico[Math.floor(Math.random() * preguntasTopico.length)];
        }

        // FUNCIONES AUXILIARES
        function generarId() {
            return Math.random().toString(36).substr(2, 9);
        }

        function obtenerNombreTopico(topico) {
            const nombres = {
                'espiritualidad': 'Espiritualidad',
                'familia': 'Familia',
                'pareja': 'Pareja',
                'padre_hijos': 'Padre/Hijos',
                'colegio': 'Colegio',
                'desarrollo_personal': 'Desarrollo Personal'
            };
            return nombres[topico] || topico;
        }

        function volverAlInicio() {
            if (intervaloActualizacion) {
                clearInterval(intervaloActualizacion);
            }
            window.location.href = 'index.html';
        }

        // LIMPIAR AL SALIR
        window.addEventListener('beforeunload', function() {
            if (intervaloActualizacion) {
                clearInterval(intervaloActualizacion);
            }
        });

        // INICIALIZAR AL CARGAR
        document.addEventListener('DOMContentLoaded', inicializarSala);
    </script>
</body>
</html>